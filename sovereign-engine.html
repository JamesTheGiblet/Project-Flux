<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sovereign Engine - Hackable Game Framework</title>
<style>
	* { margin: 0; padding: 0; box-sizing: border-box; }
	body {
		font-family: 'Courier New', monospace;
		background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
		color: #00ff88;
		overflow: hidden;
		height: 100vh;
	}
	.container { display: flex; height: 100vh; }
	.game-area {
		flex: 1;
		position: relative;
		background: #000;
		border: 2px solid #00ff88;
		margin: 10px;
	}
	#gameCanvas {
		width: 100%;
		height: 100%;
		background: #0a0a0a;
	}
	.top-right-ui {
		position: absolute;
		top: 20px;
		right: 20px;
		display: flex;
		flex-direction: column;
		align-items: flex-end;
		gap: 10px;
		z-index: 100;
	}
	#activePowerUpsContainer {
		display: flex;
		gap: 8px;
	}
	.powerup-icon {
		background: rgba(0,0,0,0.7);
		border: 1px solid #fff;
		color: #fff;
		width: 30px;
		height: 30px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		font-size: 12px;
		font-weight: bold;
	}
	.mod-panel {
		width: 300px;
		background: rgba(16, 33, 62, 0.9);
		border-left: 2px solid #00ff88;
		padding: 15px;
		overflow-y: auto;
		-webkit-backdrop-filter: blur(10px);
		backdrop-filter: blur(10px);
	}
	.header {
		text-align: center;
		padding: 15px;
		border-bottom: 1px solid #00ff88;
		margin-bottom: 15px;
	}
	.header h1 {
		font-size: 20px;
		color: #00ff88;
		text-shadow: 0 0 10px #00ff88;
	}
	.header p {
		color: #888;
		font-size: 10px;
		margin-top: 3px;
	}
	.mod-section {
		margin-bottom: 20px;
	}
	.mod-section h3 {
		color: #ff6b00;
		border-bottom: 1px solid #ff6b00;
		padding-bottom: 3px;
		margin-bottom: 8px;
		font-size: 12px;
	}
	.code-editor {
		background: #1a1a1a;
		border: 1px solid #333;
		color: #00ff88;
		font-family: 'Courier New', monospace;
		font-size: 10px;
		width: 100%;
		height: 100px;
		resize: vertical;
		padding: 8px;
		margin-bottom: 8px;
	}
	.apply-btn {
		background: #ff6b00;
		color: #000;
		border: none;
		padding: 6px 12px;
		border-radius: 3px;
		cursor: pointer;
		font-weight: bold;
		font-size: 11px;
		width: 100%;
		transition: all 0.3s ease;
	}
	.save-preset-area {
		display: flex;
		margin-top: 8px;
	}
	.preset-name-input {
		flex-grow: 1;
		background: #1a1a1a;
		border: 1px solid #333;
		color: #00ff88;
		padding: 6px;
		font-family: 'Courier New', monospace;
		font-size: 10px;
		margin-right: 5px;
	}
	.save-btn {
		background: #005588;
		color: #fff;
		border: none;
		padding: 6px 10px;
		cursor: pointer;
	}
	.execute-btn:hover {
		background: #88ffff;
		box-shadow: 0 0 8px rgba(0, 255, 255, 0.7);
	}
	.stats {
		position: fixed;
		top: 20px;
		left: 20px;
		background: rgba(0, 0, 0, 0.8);
		padding: 8px;
		border: 1px solid #00ff88;
		border-radius: 3px;
		color: #00ff88;
		font-size: 11px;
		-webkit-backdrop-filter: blur(5px);
		backdrop-filter: blur(5px);
		z-index: 100;
	}
	.manifesto {
		background: rgba(0, 0, 0, 0.9);
		border: 1px solid #ff6b00;
		border-radius: 3px;
		padding: 10px;
		margin-bottom: 15px;
		font-size: 9px;
		line-height: 1.3;
	}
	.manifesto-title {
		color: #ff6b00;
		font-weight: bold;
		margin-bottom: 5px;
	}
	.tutorial-summary {
		color: #00ffff;
		border-bottom: 1px solid #00ffff;
		padding-bottom: 3px;
		margin-bottom: 8px;
		font-size: 12px;
		cursor: pointer;
		font-weight: bold;
		list-style: none; /* Hide default arrow */
	}
	.tutorial-summary::-webkit-details-marker {
		display: none; /* Hide default arrow for Chrome */
	}
	.tutorial-summary:before {
		content: '► ';
		font-size: 10px;
	}
	details[open] > .tutorial-summary:before {
		content: '▼ ';
	}
	.tutorial-content {
		font-size: 10px;
		line-height: 1.4;
		color: #ccc;
		padding-left: 5px;
		border-left: 1px solid #333;
		margin-top: 10px;
	}
	.tutorial-content h4 {
		color: #ff6b00;
		margin-top: 10px;
		margin-bottom: 5px;
	}
	.tutorial-content p {
		margin-bottom: 5px;
	}
	.tutorial-content code {
		background: #1a1a1a;
		color: #00ff88;
		padding: 1px 4px;
		border-radius: 2px;
		font-size: 9px;
	}
	.tutorial-content pre {
		background: #1a1a1a;
		border: 1px solid #333;
		padding: 5px;
		margin: 5px 0 10px 0;
		border-radius: 3px;
		white-space: pre-wrap;
	}
	.tutorial-content pre code {
		padding: 0;
		background: none;
	}
	</style>
</head>
<body>
	<div class="container">
		<div class="game-area">
			<canvas id="gameCanvas"></canvas>
			<div class="stats" id="gameStats">
				FPS: <span id="fps">60</span><br>
				Objects: <span id="objectCount">0</span><br>
				Score: <span id="score">0</span>
			</div>
			<div class="top-right-ui">
				<div id="activePowerUpsContainer">
					</div>
			</div>
		</div>
		
		<div class="mod-panel">
			<div class="header">
				<h1>SOVEREIGN ENGINE</h1>
				<p>Hackable. Modular. Yours.</p>
			</div>

            <div class="manifesto">
                <div class="manifesto-title">⚡ BUILDER'S MANIFESTO</div>
                Every pixel is hackable. Every rule is rewritable. This is sovereign software—no gatekeepers, just pure creative freedom.
            </div>

            <div class="mod-section">
                <details>
                    <summary class="tutorial-summary">📖 HOW TO HACK</summary>
                    <div class="tutorial-content">
                        <p>Welcome, builder! This engine is yours to command. Here's how to write your own mods.</p>
                        
                        <h4>🔫 Weapon Mods</h4>
                        <p>Define how your weapon fires using the function: <code>function shoot(player, target, engine)</code>. To fire a bullet, add an object to <code>engine.projectiles</code>.</p>
                        <pre><code>// Example: A slow, powerful shot
engine.projectiles.push({
  x: player.x, y: player.y,
  vx: (target.x - player.x) / 5,
  vy: (target.y - player.y) / 5,
  size: 8, color: '#ff00ff',
  life: 3, // Seconds until it disappears
  damage: 50
});</code></pre>

                        <h4>🎮 Rule Mods</h4>
                        <p>Control the game's logic every frame using: <code>function update(engine, dt)</code>. You can use it to control enemy spawning, difficulty, or any other global game logic. Use <code>dt</code> (delta-time) for smooth, frame-rate independent logic.</p>
                        <pre><code>// Spawn a special enemy every 5 seconds
if (engine.gameTime % 5 < dt) {
  engine.spawnEnemy({
    health: 100, size: 15,
    color: '#00ffff',
    ai_type: 'linear' // or 'chase'
  });
}</code></pre>

                        <h4>🧍 Player Mods</h4>
                        <p>Change your character's stats using: <code>function modifyPlayer(player)</code>. This is run once when you click "Apply".</p>
                        <pre><code>// Make the player super fast!
player.speed = 500;
player.color = '#ffff00';</code></pre>

                        <h4>💾 Saving & Hacking</h4>
                        <p>Use the <b>Save</b> button to store your creations. They'll be here next time you play! The <b>Hack The System</b> panel gives you direct, raw access to the entire 'game' object. Use with caution... or don't!</p>
                    </div>
                </details>
            </div>

            <div class="mod-section">
                <h3>🔫 WEAPON MOD</h3>
                <select id="weaponSelector" title="Select weapon mod preset" onchange="selectPreset('weapon', this.value)"></select>
                <textarea class="code-editor" id="weaponCode" placeholder="Write or modify weapon code here..."></textarea>
                <button class="apply-btn" onclick="applyMod('weapon')">Apply Weapon</button>
                <div class="save-preset-area">
                    <input type="text" class="preset-name-input" id="weaponPresetName" placeholder="Save as new preset...">
                    <button class="save-btn" onclick="savePreset('weapon')">💾 Save</button>
                </div>
            </div>

            <div class="mod-section">
                <h3>🎮 RULES MOD</h3>
                <select id="ruleSelector" title="Select rule mod preset" onchange="selectPreset('rule', this.value)"></select>
                <textarea class="code-editor" id="ruleCode" placeholder="Write or modify game rules here..."></textarea>
                <button class="apply-btn" onclick="applyMod('rule')">Apply Rules</button>
                 <div class="save-preset-area">
                    <input type="text" class="preset-name-input" id="rulePresetName" placeholder="Save as new preset...">
                    <button class="save-btn" onclick="savePreset('rule')">💾 Save</button>
                </div>
            </div>

            <div class="mod-section">
                <h3>🧍 PLAYER MOD</h3>
                <select id="playerSelector" title="Select player mod preset" onchange="selectPreset('player', this.value)"></select>
                <textarea class="code-editor" id="playerCode" placeholder="Write or modify player properties here..."></textarea>
                <button class="apply-btn" onclick="applyMod('player')">Apply Player</button>
                 <div class="save-preset-area">
                    <input type="text" class="preset-name-input" id="playerPresetName" placeholder="Save as new preset...">
                    <button class="save-btn" onclick="savePreset('player')">💾 Save</button>
                </div>
            </div>

			<div class="mod-section">
				<h3>💻 HACK THE SYSTEM</h3>
				<textarea class="code-editor" id="hackCode" placeholder="/* DANGER ZONE */
// Code here has direct access to the 'game' object.
// Examples:
// player.health = 999;
// game.score += 1000;"></textarea>
				<button class="execute-btn" onclick="executeHack()">⚡ Execute</button>
			</div>
		</div>
	</div>

	<script src="engine.js"></script>
	<script src="power-ups.js"></script>
	<script src="mod-loader.js"></script>
	<script>
		// --- MOD SYSTEM ---

        function selectPreset(modType, presetName) {
            const textarea = document.getElementById(`${modType}Code`);
            const presets = game.allPresets[modType];
            if (presets && presets[presetName]) {
                textarea.value = presets[presetName];
            }
        }

        function applyMod(modType) {
            const code = document.getElementById(`${modType}Code`).value;
            try {
                const functionBody = code.substring(code.indexOf('{') + 1, code.lastIndexOf('}'));
                
                switch(modType) {
                    case 'weapon':
                        game.weaponShoot = new Function('player', 'target', 'engine', functionBody);
                        break;
                    case 'rule':
                        game.rulesUpdate = new Function('engine', 'dt', functionBody);
                        break;
                    case 'player':
                        const modFunc = new Function('player', functionBody);
                        modFunc(game.player);
                        break;
                }
                console.log(`${modType.charAt(0).toUpperCase() + modType.slice(1)} mod applied!`);
            } catch (e) {
                alert(`Error in ${modType} code: ` + e.message);
            }
        }

        function savePreset(modType) {
            const nameInput = document.getElementById(`${modType}PresetName`);
            const presetName = nameInput.value.trim();
            const code = document.getElementById(`${modType}Code`).value;

            if (!presetName) {
                alert('Please enter a name for your preset.');
                return;
            }
            // Prevent overwriting a file-based mod
            if (modManifest[modType] && modManifest[modType][presetName]) {
                alert(`Cannot overwrite a file-
                return;
            }

            const storageKey = `sovereign_${modType}_mods`;
            let customMods = JSON.parse(localStorage.getItem(storageKey)) || {};
            customMods[presetName] = code;
            localStorage.setItem(storageKey, JSON.stringify(customMods));

            alert(`Preset "${presetName}" saved!`);
            nameInput.value = '';
            initializeModSystem();
            selectPreset(modType, presetName);
        }

        function executeHack() {
            const code = document.getElementById('hackCode').value;
            if (!code) return; // Don't run empty code
            try {
                // The code is executed with 'game', 'player', and 'engine' available as variables.
                const hackFunction = new Function('game', 'player', 'engine', code);
                hackFunction(game, game.player, game);
                console.log('%c⚡ Hack executed successfully!', 'color: #00ffff');
            } catch (e) {
                alert('Error in hack code: ' + e.message);
                console.error('Hack execution failed:', e);
            }
        }

        function initializeModSystem() {
            game.allPresets = { weapon: {}, rule: {}, player: {} };
            const defaultPresets = { weapon: weaponPresets, rule: rulesPresets, player: playerPresets };

            for (const modType in game.allPresets) {
                const customMods = JSON.parse(localStorage.getItem(`sovereign_${modType}_mods`)) || {};
                game.allPresets[modType] = { ...defaultPresets[modType], ...customMods };

                const selector = document.getElementById(`${modType}Selector`);
                selector.innerHTML = ''; // Clear dropdown

                for (const presetName in game.allPresets[modType]) {
                    const option = document.createElement('option');
                    option.value = presetName;
                    const isCustom = !defaultPresets[modType].hasOwnProperty(presetName);
                    option.textContent = isCustom ? `[C] ${presetName}` : presetName.charAt(0).toUpperCase() + presetName.slice(1);
                    selector.appendChild(option);
                }
            }
        }
        
		let game;
		window.onload = function() {
			game = new SovereignEngine();
			initializeModSystem();

			// Select and apply default mods on startup
			selectPreset('weapon', 'default');
			selectPreset('rule', 'default');
			selectPreset('player', 'default');
			applyMod('rule');
			applyMod('player');

			console.log(`
🚀 SOVEREIGN ENGINE LOADED
=======================
WASD/Arrows: Move
Mouse: Aim | Click/Space: Shoot
Edit code in the panel →
Every system is hackable!
`);
		};
	</script>
</body>
</html>