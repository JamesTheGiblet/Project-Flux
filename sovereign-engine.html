<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sovereign Engine - Hackable Game Framework</title>
<style>
	* { margin: 0; padding: 0; box-sizing: border-box; }
	body {
		font-family: 'Courier New', monospace;
		background: linear-gradient(135deg, #0a0a0a 0%, #1a1a2e 50%, #16213e 100%);
		color: #00ff88;
		overflow: hidden;
		height: 100vh;
	}
	.container { display: flex; height: 100vh; }
	.game-area {
		flex: 1;
		position: relative;
		background: #000;
		border: 2px solid #00ff88;
		margin: 10px;
	}
	#gameCanvas {
		width: 100%;
		height: 100%;
		background: #0a0a0a;
	}
	#pauseOverlay {
		position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); color: #00ff88; font-size: 72px; text-shadow: 0 0 20px #00ff88; display: none; align-items: center; justify-content: center; z-index: 999;
		font-weight: bold;
		flex-direction: column;
	}
	#mainMenu {
		position: absolute; top: 0; left: 0; width: 100%; height: 100%;
		background: linear-gradient(180deg, rgba(10, 10, 20, 0.95) 0%, rgba(22, 33, 62, 0.98) 100%);
		display: flex; align-items: center; justify-content: center;
		z-index: 1001;
		-webkit-backdrop-filter: blur(5px);
		backdrop-filter: blur(5px);
	}
	.menu-container { text-align: center; }
	.menu-title {
		font-size: 64px;
		color: #00ff88;
		text-shadow: 0 0 15px #00ff88, 0 0 30px #00ff88;
		margin-bottom: 40px;
	}
	.menu-button {
		background: #ff6b00;
		color: #000;
		border: none;
		padding: 15px 40px;
		font-size: 24px;
		font-family: 'Courier New', monospace;
		font-weight: bold;
		cursor: pointer;
		transition: all 0.3s ease;
	}
	.menu-button:hover {
		background: #ffaa00;
		box-shadow: 0 0 20px #ffaa00;
	}
	#upgradeScreen {
		position: absolute; top: 0; left: 0; width: 100%; height: 100%;
		background: rgba(10, 10, 20, 0.95);
		display: none; /* Initially hidden */
		align-items: center; justify-content: center;
		z-index: 1000;
		-webkit-backdrop-filter: blur(5px);
		backdrop-filter: blur(5px);
		color: #fff;
	}
	.upgrade-container {
		text-align: center;
		background: rgba(0,0,0,0.5);
		padding: 40px;
		border: 2px solid #00ff88;
		box-shadow: 0 0 20px #00ff88;
	}
	.upgrade-container h1 {
		color: #00ff88;
		font-size: 48px;
		text-shadow: 0 0 10px #00ff88;
		margin-bottom: 10px;
	}
	.upgrade-options {
		display: flex;
		gap: 15px; /* Reduced gap to fit more options */
		margin: 30px 0;
	}
	.upgrade-btn {
		background: #1a1a2e;
		border: 2px solid #00ffff;
		color: #00ffff;
		padding: 15px;
		cursor: pointer;
		transition: all 0.3s ease;
		width: 140px;
	}
	.upgrade-btn:hover:not(:disabled) {
		background: #00ffff;
		color: #000;
		box-shadow: 0 0 15px #00ffff;
	}
	.upgrade-btn:disabled {
		border-color: #555;
		color: #555;
		cursor: not-allowed;
	}
	.upgrade-cost {
		font-size: 12px;
		color: #ffdd00;
	}
	.upgrade-score-label { font-size: 20px; color: #ffdd00; }
	#continueButton { background: #ff6b00; color: #000; border: none; padding: 10px 30px; font-size: 18px; font-family: 'Courier New', monospace; font-weight: bold; cursor: pointer; transition: all 0.3s ease; margin-top: 20px; }
	#comboDisplay {
		position: absolute;
		top: 100px;
		left: 50%;
		transform: translateX(-50%) scale(1.2);
		color: #ffdd00;
		font-size: 48px;
		font-weight: bold;
		text-shadow: 0 0 10px #ff6b00, 0 0 20px #ff6b00;
		pointer-events: none;
		z-index: 1000;
		opacity: 0;
		transition: opacity 0.2s ease-out, transform 0.2s ease-out;
	}
	#comboDisplay.visible {
		opacity: 1;
		transform: translateX(-50%) scale(1);
	}
	.top-right-ui {
		position: absolute;
		top: 20px;
		right: 20px;
		display: flex;
		flex-direction: column;
		align-items: flex-end;
		gap: 10px;
		z-index: 100;
	}
	#activePowerUpsContainer {
		display: flex;
		gap: 8px;
	}
	.powerup-icon {
		background: rgba(0,0,0,0.7);
		border: 1px solid #fff;
		color: #fff;
		width: 30px;
		height: 30px;
		border-radius: 50%;
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative; /* For the timer bar */
		overflow: hidden; /* To contain the timer bar */
		font-size: 12px;
		font-weight: bold;
	}
	.powerup-timer {
		position: absolute;
		bottom: 0;
		left: 0;
		height: 4px;
		background: rgba(255, 255, 255, 0.8);
		transition: width 0.1s linear;
	}
	.mod-panel {
		width: 300px;
		background: rgba(16, 33, 62, 0.9);
		border-left: 2px solid #00ff88;
		padding: 15px;
		position: relative; /* For positioning the toggle button */
		transition: transform 0.4s ease-in-out;
		overflow-y: auto;
		-webkit-backdrop-filter: blur(10px);
		backdrop-filter: blur(10px);
	}
	.mod-panel.collapsed {
		transform: translateX(calc(100% - 2px)); /* Hide panel, leave border visible */
	}
	.mod-panel-toggle {
		position: absolute;
		top: 50%;
		left: 0;
		transform: translate(-100%, -50%);
		width: 25px;
		height: 80px;
		background: rgba(255, 107, 0, 0.7);
		color: #fff;
		text-shadow: 0 0 5px #000;
		display: flex;
		align-items: center;
		justify-content: center;
		cursor: pointer;
		font-size: 28px;
		font-weight: bold;
		border: 2px solid #00ff88;
		border-right: none;
		border-radius: 10px 0 0 10px;
		transition: background-color 0.3s ease;
		z-index: 10;
	}
	.mod-panel-toggle:hover {
		background-color: #ff6b00;
	}
	.header {
		text-align: center;
		padding: 15px;
		border-bottom: 1px solid #00ff88;
		margin-bottom: 15px;
	}
	.header h1 {
		font-size: 20px;
		color: #00ff88;
		text-shadow: 0 0 10px #00ff88;
	}
	.header p {
		color: #888;
		font-size: 10px;
		margin-top: 3px;
	}
	.mod-section {
		margin-bottom: 20px;
	}
	.mod-section h3 {
		color: #ff6b00;
		border-bottom: 1px solid #ff6b00;
		padding-bottom: 3px;
		margin-bottom: 8px;
		font-size: 12px;
	}
	.code-editor {
		background: #1a1a1a;
		border: 1px solid #333;
		color: #00ff88;
		font-family: 'Courier New', monospace;
		font-size: 10px;
		width: 100%;
		height: 100px;
		resize: vertical;
		padding: 8px;
		margin-bottom: 8px;
	}
	.apply-btn, .execute-btn {
		background: #ff6b00;
		color: #000;
		border: none;
		padding: 5px 12px;
		border-radius: 3px;
		cursor: pointer;
		font-weight: bold;
		font-size: 11px;
		width: 100%;
		transition: all 0.3s ease;
	}
	.save-preset-area {
		display: flex;
		margin-top: 8px;
	}
	.preset-name-input {
		flex-grow: 1;
		background: #1a1a1a;
		border: 1px solid #333;
		color: #00ff88;
		padding: 4px 6px;
		font-family: 'Courier New', monospace;
		font-size: 10px;
		margin-right: 5px;
	}
	.save-btn {
		background: #005588;
		color: #fff;
		border: none;
		padding: 4px 8px;
		cursor: pointer;
	}
	.execute-btn:hover {
		background: #88ffff;
		box-shadow: 0 0 8px rgba(0, 255, 255, 0.7);
	}
	.stats {
		position: fixed;
		top: 20px;
		left: 20px;
		background: rgba(0, 0, 0, 0.8);
		padding: 8px;
		border: 1px solid #00ff88;
		border-radius: 3px;
		color: #00ff88;
		font-size: 11px;
		-webkit-backdrop-filter: blur(5px);
		backdrop-filter: blur(5px);
		z-index: 100;
	}
	.stats-divider {
		border-color: #333;
		margin: 4px 0;
	}
	.manifesto {
		background: rgba(0, 0, 0, 0.9);
		border: 1px solid #ff6b00;
		border-radius: 3px;
		padding: 10px;
		margin-bottom: 15px;
		font-size: 9px;
		line-height: 1.3;
	}
	.manifesto-title {
		color: #ff6b00;
		font-weight: bold;
		margin-bottom: 5px;
	}
	.tutorial-summary {
		color: #00ffff;
		border-bottom: 1px solid #00ffff;
		padding-bottom: 3px;
		margin-bottom: 8px;
		font-size: 12px;
		cursor: pointer;
		font-weight: bold;
		list-style: none; /* Hide default arrow */
	}
	.tutorial-summary::-webkit-details-marker {
		display: none; /* Hide default arrow for Chrome */
	}
	.tutorial-summary:before {
		content: '► ';
		font-size: 10px;
	}
	details[open] > .tutorial-summary:before {
		content: '▼ ';
	}
	.tutorial-content {
		font-size: 10px;
		line-height: 1.4;
		color: #ccc;
		padding-left: 5px;
		border-left: 1px solid #333;
		margin-top: 10px;
	}
	.tutorial-content h4 {
		color: #ff6b00;
		margin-top: 10px;
		margin-bottom: 5px;
	}
	.tutorial-content p {
		margin-bottom: 5px;
	}
	.tutorial-content code {
		background: #1a1a1a;
		color: #00ff88;
		padding: 1px 4px;
		border-radius: 2px;
		font-size: 9px;
	}
	.tutorial-content pre {
		background: #1a1a1a;
		border: 1px solid #333;
		padding: 5px;
		margin: 5px 0 10px 0;
		border-radius: 3px;
		white-space: pre-wrap;
	}
	.tutorial-content pre code {
		padding: 0;
		background: none;
	}
	.menu-highscore {
		margin-top: 30px;
		color: #aaa;
	}
	</style>
</head>
<body>
	<div class="container">
		<div class="game-area">
			<canvas id="gameCanvas"></canvas>
			<div id="mainMenu">
				<div class="menu-container">
					<h1 class="menu-title">SOVEREIGN ENGINE</h1>
					<button id="startButton" class="menu-button">START GAME</button>
					<p class="menu-highscore">High Score: <span id="menuHighScore">0</span></p>
				</div>
			</div>
			<div id="upgradeScreen">
				<div class="upgrade-container">
					<h1>LEVEL COMPLETE</h1>
					<p>Spend your score on upgrades!</p>
					<p class="upgrade-score-label">Score: <span id="upgradeScore">0</span></p>
					<div class="upgrade-options">
						<button class="upgrade-btn" data-upgrade="maxHealth" data-cost="500">
							+20 Max Health<br><span class="upgrade-cost">(Cost: 500)</span>
						</button>
						<button class="upgrade-btn" data-upgrade="fireRate" data-cost="750">
							+1 Fire Rate<br><span class="upgrade-cost">(Cost: 750)</span>
						</button>
						<button class="upgrade-btn" data-upgrade="speed" data-cost="400">
							+10% Base Speed<br><span class="upgrade-cost">(Cost: 400)</span>
						</button>
						<button class="upgrade-btn" data-upgrade="damage" data-cost="1000">
							+10% Damage<br><span class="upgrade-cost">(Cost: 1000)</span>
						</button>
						<button class="upgrade-btn" data-upgrade="restoreHealth" data-cost="250">
							Restore 50 Health<br><span class="upgrade-cost">(Cost: 250)</span>
						</button>
						<button class="upgrade-btn" data-upgrade="extraLife" data-cost="1500">
							+1 Extra Life<br><span class="upgrade-cost">(Cost: 1500)</span>
						</button>
					</div>
					<button id="continueButton">Continue to Next Level</button>
				</div>
			</div>
			<div id="comboDisplay"></div>
			<div id="pauseOverlay">PAUSED</div>
			<div class="stats" id="gameStats">
				FPS: <span id="fps">60</span><br>
				Objects: <span id="objectCount">0</span><br>
				<hr class="stats-divider">
				Score: <span id="score">0</span><br>
				Lives: <span id="livesCount">3</span><br>
				High Score: <span id="highScore">0</span><br>
				<hr class="stats-divider">
				Level: <span id="levelCount">1</span><br>
				Progress: <span id="waveCount">Wave 1</span>
			</div>
			<div class="top-right-ui">
				<div id="activePowerUpsContainer">
					</div>
			</div>
		</div>
		
		<div class="mod-panel" id="modPanel">
			<div class="header">
				<div class="mod-panel-toggle" id="modPanelToggle" title="Toggle Mod Panel">›</div>
				<h1>SOVEREIGN ENGINE</h1>
				<p>Hackable. Modular. Yours.</p>
			</div>

            <div class="manifesto">
                <div class="manifesto-title">⚡ BUILDER'S MANIFESTO</div>
                Every pixel is hackable. Every rule is rewritable. This is sovereign software—no gatekeepers, just pure creative freedom.
            </div>

            <div class="mod-section">
                <details>
                    <summary class="tutorial-summary">📖 HOW TO HACK</summary>
                    <div class="tutorial-content">
                        <p>Welcome, builder! This engine is yours to command. Here's how to write your own mods.</p>
                        
                        <h4>🔫 Weapon Mods</h4>
                        <p>Define how your weapon fires using the function: <code>function shoot(player, target, engine)</code>. To fire a bullet, add an object to <code>engine.projectiles</code>.</p>
                        <pre><code>// Example: A slow, powerful shot
engine.projectiles.push({
  x: player.x, y: player.y,
  vx: (target.x - player.x) / 5,
  vy: (target.y - player.y) / 5,
  size: 8, color: '#ff00ff',
  life: 3, // Seconds until it disappears
  damage: 50
});</code></pre>

                        <h4>🎮 Rule Mods</h4>
                        <p>Control the game's logic every frame using: <code>function update(engine, dt)</code>. You can use it to control enemy spawning, difficulty, or any other global game logic. Use <code>dt</code> (delta-time) for smooth, frame-rate independent logic.</p>
                        <pre><code>// Spawn a special enemy every 5 seconds
if (engine.gameTime % 5 < dt) {
  engine.spawnEnemy({
    health: 100, size: 15,
    color: '#00ffff',
    ai_type: 'linear' // or 'chase'
  });
}</code></pre>

                        <h4>🧍 Player Mods</h4>
                        <p>Change your character's stats using: <code>function modifyPlayer(player)</code>. This is run once when you click "Apply".</p>
                        <pre><code>// Make the player super fast!
player.speed = 500;
player.color = '#ffff00';</code></pre>

                        <h4>💾 Saving & Hacking</h4>
                        <p>Use the <b>Save</b> button to store your creations. They'll be here next time you play! The <b>Hack The System</b> panel gives you direct, raw access to the entire 'game' object. Use with caution... or don't!</p>
                    </div>
                </details>
            </div>

            <div class="mod-section">
                <h3>🔫 WEAPON MOD</h3>
                <select id="weaponSelector" title="Select weapon mod preset" onchange="selectPreset('weapon', this.value)"></select>
                <textarea class="code-editor" id="weaponCode" placeholder="Write or modify weapon code here..."></textarea>
                <button class="apply-btn" onclick="applyMod('weapon')">Apply Weapon</button>
                <div class="save-preset-area">
                    <input type="text" class="preset-name-input" id="weaponPresetName" placeholder="Save as new preset...">
                    <button class="save-btn" onclick="savePreset('weapon')">💾 Save</button>
                </div>
            </div>

            <div class="mod-section">
                <h3>🎮 RULES MOD</h3>
                <select id="ruleSelector" title="Select rule mod preset" onchange="selectPreset('rule', this.value)"></select>
                <textarea class="code-editor" id="ruleCode" placeholder="Write or modify game rules here..."></textarea>
                <button class="apply-btn" onclick="applyMod('rule')">Apply Rules</button>
                 <div class="save-preset-area">
                    <input type="text" class="preset-name-input" id="rulePresetName" placeholder="Save as new preset...">
                    <button class="save-btn" onclick="savePreset('rule')">💾 Save</button>
                </div>
            </div>

            <div class="mod-section">
                <h3>🧍 PLAYER MOD</h3>
                <select id="playerSelector" title="Select player mod preset" onchange="selectPreset('player', this.value)"></select>
                <textarea class="code-editor" id="playerCode" placeholder="Write or modify player properties here..."></textarea>
                <button class="apply-btn" onclick="applyMod('player')">Apply Player</button>
                 <div class="save-preset-area">
                    <input type="text" class="preset-name-input" id="playerPresetName" placeholder="Save as new preset...">
                    <button class="save-btn" onclick="savePreset('player')">💾 Save</button>
                </div>
            </div>

            <div class="mod-section">
                <h3>❤️ LIFE MOD</h3>
                <select id="lifeSelector" title="Select life mod preset" onchange="selectPreset('life', this.value)"></select>
                <textarea class="code-editor" id="lifeCode" placeholder="Write or modify life gain rules here..."></textarea>
                <button class="apply-btn" onclick="applyMod('life')">Apply Life Rules</button>
                <div class="save-preset-area">
                    <input type="text" class="preset-name-input" id="lifePresetName" placeholder="Save as new preset...">
                    <button class="save-btn" onclick="savePreset('life')">💾 Save</button>
                </div>
            </div>

            <div class="mod-section">
                <h3>🌱 SEED</h3>
                <input type="number" class="code-editor" id="seedCode" placeholder="Enter a number for the game seed..." value="12345">
                <button class="apply-btn" onclick="applyMod('seed')">Apply Seed</button>
                <div class="save-preset-area">
                    <input type="text" class="preset-name-input" id="seedPresetName" placeholder="Save as new preset...">
                    <button class="save-btn" onclick="savePreset('seed')">💾 Save</button>
                </div>
            </div>

            <div class="mod-section">
                <h3>👾 BOSS AI MOD</h3>
                <select id="bossAISelector" title="Select boss AI preset" onchange="selectPreset('bossAI', this.value)"></select>
                <textarea class="code-editor" id="bossAICode" placeholder="Write or modify boss AI here..."></textarea>
                <button class="apply-btn" onclick="applyMod('bossAI')">Apply Boss AI</button>
                <div class="save-preset-area">
                    <input type="text" class="preset-name-input" id="bossAIPresetName" placeholder="Save as new preset...">
                    <button class="save-btn" onclick="savePreset('bossAI')">💾 Save</button>
                </div>
            </div>

            <div class="mod-section">
                <h3>💻 HACK THE SYSTEM</h3>
                <textarea class="code-editor" id="hackCode" placeholder="/* DANGER ZONE */
// Code here has direct access to the 'game' object.
// Examples:
// player.health = 999;
// game.score += 1000;"></textarea>
                <button class="execute-btn" onclick="executeHack()">⚡ Execute</button>
            </div>
        </div>
    </div>

    <script src="engine.js"></script> <!-- Core engine remains in root -->
    <script src="mods/weapons/weapons.js"></script>
    <script src="mods/rules/rules.js"></script>
    <script src="mods/player/player.js"></script>
    <script src="mods/health/life.js"></script>
    <script src="mods/enemies/boss-ai.js"></script>
    <script src="mods/power-ups/power-ups.js"></script>
    <script>
        // --- MOD SYSTEM ---

		let audioCtx;
		function playDeathSound() {
			// Create audio context on first use (as required by browsers)
			if (!audioCtx) {
				try {
					audioCtx = new (window.AudioContext || window.webkitAudioContext)();
				} catch (e) {
					console.error("Web Audio API is not supported in this browser.");
					return;
				}
			}
			const oscillator = audioCtx.createOscillator();
			const gainNode = audioCtx.createGain();
			oscillator.connect(gainNode);
			gainNode.connect(audioCtx.destination);
			oscillator.type = 'sawtooth';
			gainNode.gain.setValueAtTime(0.2, audioCtx.currentTime);
			oscillator.frequency.setValueAtTime(200, audioCtx.currentTime);
			oscillator.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.8);
			gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.8);
			oscillator.start(audioCtx.currentTime);
			oscillator.stop(audioCtx.currentTime + 0.8);
		}

        function applyMod(modType) {
            const code = document.getElementById(`${modType}Code`).value;
            try {
                // Using eval is the most robust way to parse a full function string provided by the user.
                // The parentheses `()` turn the function declaration into an expression, returning the function object.
                const modFunc = eval(`(${code})`);

                if (typeof modFunc !== 'function') {
                    throw new Error("The provided code is not a valid function definition.");
                }

                switch(modType) {
                    case 'weapon':
                        game.weaponShoot = modFunc;
                        break;
                    case 'rule':
                        game.rulesUpdate = modFunc;
                        break;
                    case 'player':
                        modFunc(game.player);
                        break;
                    case 'life':
                        game.lifeRuleUpdate = modFunc;
                        break;
                    case 'seed':
                        const seedValue = parseInt(code);
                        if (isNaN(seedValue)) {
                            throw new Error("Seed must be a number.");
                        }
                        game.setSeed(seedValue);
                        break;
                    case 'bossAI':
                        game.bossAIUpdate = modFunc;
                        break;
                }
                console.log(`${modType.charAt(0).toUpperCase() + modType.slice(1)} mod applied!`);
            } catch (e) {
                alert(`Error in ${modType} code: ${e.message}`);
            }
        }

        function savePreset(modType) {
            const nameInput = document.getElementById(`${modType}PresetName`);
            const presetName = nameInput.value.trim();
            let code;
            if (modType === 'seed') {
                code = document.getElementById(`${modType}Code`).value; // Get value from input
            } else {
                code = document.getElementById(`${modType}Code`).value; // Get value from textarea
            }

            if (!presetName) {
                alert('Please enter a name for your preset.');
                return;
            }
            if (presetName === 'default') {
                alert('Cannot overwrite the "default" preset.');
                return;
            }

            const storageKey = `sovereign_${modType}_mods`;
            let customMods = JSON.parse(localStorage.getItem(storageKey)) || {};
            customMods[presetName] = code;
            localStorage.setItem(storageKey, JSON.stringify(customMods));

            alert(`Preset "${presetName}" saved!`);
            nameInput.value = '';
            initializeModSystem();
            selectPreset(modType, presetName);
        }

        function executeHack() {
            const code = document.getElementById('hackCode').value;
            if (!code) return; // Don't run empty code
            try {
                // The code is executed with 'game', 'player', and 'engine' available as variables.
                const hackFunction = new Function('game', 'player', 'engine', code);
                hackFunction(game, game.player, game);
                console.log('%c⚡ Hack executed successfully!', 'color: #00ffff');
            } catch (e) {
                alert('Error in hack code: ' + e.message);
                console.error('Hack execution failed:', e);
            }
        }

        function selectPreset(modType, presetName) {
            const element = document.getElementById(`${modType}Code`);
            const presets = game.allPresets[modType];
            if (presets && presets[presetName]) { 
                element.value = presets[presetName]; 
            }
        }

        function initializeModSystem() {
            game.allPresets = { weapon: {}, rule: {}, player: {}, life: {}, bossAI: {}, seed: {} };
            const defaultPresets = { weapon: weaponPresets, rule: rulesPresets, player: playerPresets, life: lifePresets, bossAI: bossAIPresets, seed: { default: '12345' } };

            for (const modType in game.allPresets) {
                // Seed mod doesn't have a selector dropdown
                if (modType === 'seed') continue;

                const customMods = JSON.parse(localStorage.getItem(`sovereign_${modType}_mods`)) || {};
                game.allPresets[modType] = { ...defaultPresets[modType], ...customMods };

                const selector = document.getElementById(`${modType}Selector`);
                selector.innerHTML = ''; // Clear dropdown

                for (const presetName in game.allPresets[modType]) {
                    const option = document.createElement('option');
                    option.value = presetName;
                    const isCustom = !defaultPresets[modType].hasOwnProperty(presetName);
                    option.textContent = isCustom ? `[C] ${presetName}` : presetName.charAt(0).toUpperCase() + presetName.slice(1);
                    selector.appendChild(option);
                }
            }
            // Handle seed preset loading separately as it uses an input, not a select
            const seedCustomMods = JSON.parse(localStorage.getItem(`sovereign_seed_mods`)) || {};
            game.allPresets.seed = { ...defaultPresets.seed, ...seedCustomMods };
        }

        let game;
        window.onload = function() {
            game = new SovereignEngine();
			const mainMenu = document.getElementById('mainMenu');
			const pauseOverlay = document.getElementById('pauseOverlay');
			const highScore = parseInt(localStorage.getItem('sovereign_highscore') || '0');
			document.getElementById('highScore').textContent = highScore;

			// --- CORE GAME STATE & SYSTEMS PATCHING ---
			game.player.lives = 3;
			game.player.maxLives = 5; // Set a cap
			game.state = 'MENU'; // MENU, PLAYING, PAUSED, GAMEOVER, UPGRADE
			game.lifeRuleUpdate = function(engine, dt) {}; // Default empty function
			// --- LEVEL & BOSS STATE ---
			game.level = 1;
			game.wave = 1;
			game.wavesPerLevel = 3;
			game.waveState = 'WAVE'; // WAVE, BOSS, INTERMISSION
			game.wasBossPresent = false;
			game.waveEnemiesSpawned = 0;
			game.waveEnemiesTotal = 0;
			// --- COMBO STATE ---
			game.comboCount = 0;
			game.comboTimer = 0;

			// Centralized game start/reset logic
			game.startGame = function() {
				this.player.lives = 3;
				this.score = 0;
				this.player.health = this.player.maxHealth || 100;
				this.player.x = this.canvas.width / 2;
				this.player.y = this.canvas.height / 2;
				this.enemies = [];
				this.projectiles = [];
				this.level = 1;
				this.wave = 1;
				this.waveState = 'WAVE';
				this.waveEnemiesSpawned = 0;
				this.wasBossPresent = false;
				this.waveEnemiesTotal = 0;
				this.comboCount = 0;
				this.comboTimer = 0;
				// Re-apply default seed
				selectPreset('seed', 'default');
				applyMod('seed');
				this.initializeAudio(); // Re-initialize audio for the new game
				pauseOverlay.innerHTML = 'PAUSED'; // Reset for pause functionality
				pauseOverlay.style.display = 'none';
				applyMod('rule'); // Re-apply rules to restart spawners
				applyMod('player'); // Re-apply player stats
				this.state = 'PLAYING';
				console.log("Game Reset!");
			};

			// Wrap the engine's core update loop to add our own logic for
			// lives, death, game over, pausing, and custom life rules.
			const originalUpdate = game.update;
			if (typeof originalUpdate === 'function') {
				game.update = function(dt) {
					// Handle state transitions that pause the game
					if (this.state === 'UPGRADE') {
						const upgradeScreen = document.getElementById('upgradeScreen');
						if (upgradeScreen.style.display !== 'flex') {
							document.getElementById('upgradeScore').textContent = this.score;
							// Disable buttons if player can't afford them
							document.querySelectorAll('.upgrade-btn').forEach(b => {
								let disabled = this.score < parseInt(b.dataset.cost);
								if (b.dataset.upgrade === 'extraLife' && this.player.lives >= this.player.maxLives) {
									disabled = true;
									b.title = "Max lives reached";
								}
								b.disabled = disabled;
							});
							upgradeScreen.style.display = 'flex';
						}
						return; // Pause game logic
					}

					// Only run game logic when in the 'PLAYING' state
					if (this.state !== 'PLAYING') return;

					// Check for player death before the main update
					if (this.player.health <= 0) {
						this.player.lives--;
						
						if (this.player.lives > 0) {
							// Respawn
							this.player.health = this.player.maxHealth || 100;
							this.player.x = this.canvas.width / 2;
							this.player.y = this.canvas.height / 2;
							this.player.vx = 0; this.player.vy = 0; // Stop momentum
						} else {
							// Game Over
							this.state = 'GAMEOVER';
							playDeathSound();
							this.shutdown(); // Properly close the audio context

							const currentHighScore = parseInt(localStorage.getItem('sovereign_highscore') || '0');
							let newHighScore = currentHighScore;
							if (this.score > currentHighScore) {
								newHighScore = this.score;
								localStorage.setItem('sovereign_highscore', this.score);
								document.getElementById('highScore').textContent = newHighScore;
							}

							pauseOverlay.innerHTML = `GAME OVER<br>
								<small style="font-size: 24px;">Final Score: ${this.score}</small><small style="font-size: 18px; color: #aaa; margin-top: 10px;">High Score: ${newHighScore}</small><br><small style="font-size: 20px; margin-top: 20px;">Press 'R' to Restart</small>`;
							pauseOverlay.style.display = 'flex';
							return; // Stop this frame
						}
					}

					// Handle combo timer and UI, which is part of the patched game logic
					if (this.comboTimer > 0) {
						this.comboTimer -= dt;
						if (this.comboTimer <= 0) {
							this.comboCount = 0;
						}
					}
					const comboDisplay = document.getElementById('comboDisplay');
					comboDisplay.textContent = `x${this.comboCount} COMBO!`;
					comboDisplay.classList.toggle('visible', this.comboCount > 1);

					// Run the original engine update
					originalUpdate.call(this, dt);

					// Run the hackable life rules
					this.lifeRuleUpdate(this, dt);

					// Update UI stats
					document.getElementById('livesCount').textContent = this.player.lives;
					document.getElementById('levelCount').textContent = this.level;
					const waveCountUI = document.getElementById('waveCount');
					if (this.waveState === 'WAVE') {
						const enemiesRemaining = this.waveEnemiesTotal - this.waveEnemiesSpawned + this.enemies.length;
						waveCountUI.textContent = `Wave ${this.wave} (${enemiesRemaining} left)`;
					} else if (this.waveState === 'BOSS') {
						waveCountUI.textContent = `** BOSS **`;
						waveCountUI.style.color = '#ff3333';
					}
				};
			}

			// --- UI & STATE LISTENERS ---
			document.getElementById('startButton').addEventListener('click', () => {
				mainMenu.style.display = 'none';
				game.startGame();
			});

			// --- UPGRADE SCREEN LISTENERS ---
			document.querySelectorAll('.upgrade-btn').forEach(btn => {
				btn.addEventListener('click', () => {
					const cost = parseInt(btn.dataset.cost);
					if (game.score >= cost) {
						game.score -= cost;
						const upgradeType = btn.dataset.upgrade;
						switch(upgradeType) {
							case 'maxHealth':
								game.player.maxHealth = (game.player.maxHealth || 100) + 20;
								game.player.health += 20; // Also give the health
								break;
							case 'fireRate':
								game.player.fireRate = (game.player.fireRate || 5) + 1;
								break;
							case 'speed':
								game.player.baseSpeed *= 1.10;
								game.player.speed = game.player.baseSpeed;
								break;
							case 'damage':
								game.player.damageMultiplier = (game.player.damageMultiplier || 1) * 1.10;
								break;
							case 'restoreHealth':
								game.player.health += 50;
								if (game.player.health > game.player.maxHealth) {
									game.player.health = game.player.maxHealth;
								}
								break;
							case 'extraLife':
								if (game.player.lives < game.player.maxLives) {
									game.player.lives++;
								}
								break;
						}
						// Update UI and re-check button disabled states
						document.getElementById('upgradeScore').textContent = game.score;
						document.querySelectorAll('.upgrade-btn').forEach(b => {
							let disabled = game.score < parseInt(b.dataset.cost);
							if (b.dataset.upgrade === 'extraLife' && game.player.lives >= game.player.maxLives) {
								disabled = true;
								b.title = "Max lives reached";
							}
							b.disabled = disabled;
						});
					}
				});
			});

			document.getElementById('continueButton').addEventListener('click', () => {
				document.getElementById('upgradeScreen').style.display = 'none';
				game.level++;
				game.wave = 1;
				game.waveState = 'INTERMISSION';
				game.intermissionTime = game.gameTime + 3; // 3 second break
				game.state = 'PLAYING';
			});

			window.addEventListener('keydown', (e) => {
				const key = e.key.toLowerCase();
				if (key === 'p' && game.update) {
					if (game.state === 'PLAYING') {
						game.state = 'PAUSED';
						pauseOverlay.innerHTML = 'PAUSED';
						pauseOverlay.style.display = 'flex';
					} else if (game.state === 'PAUSED') {
						game.state = 'PLAYING';
						pauseOverlay.style.display = 'none';
					}
				}
				if (key === 'r' && game.state === 'GAMEOVER') {
					game.startGame();
				}
			});

			// --- COLLAPSIBLE MOD PANEL ---
			const modPanel = document.getElementById('modPanel');
			const modPanelToggle = document.getElementById('modPanelToggle');

			if (modPanel && modPanelToggle) {
				modPanelToggle.addEventListener('click', () => {
					const isCollapsed = modPanel.classList.toggle('collapsed');
					modPanelToggle.innerHTML = isCollapsed ? '‹' : '›';
					localStorage.setItem('sovereign_panel_collapsed', isCollapsed);
				});

			}
            initializeModSystem();

            // Select and apply default mods on startup
            selectPreset('weapon', 'default');
            selectPreset('rule', 'level-progression');
            selectPreset('player', 'default');
            selectPreset('life', 'points-based');
            selectPreset('seed', 'default'); // Load default seed into input
            selectPreset('bossAI', 'default');
            applyMod('life');
            applyMod('rule');
            applyMod('player');
            applyMod('bossAI');

            console.log(`
🚀 SOVEREIGN ENGINE LOADED
=======================
WASD/Arrows: Move
Mouse: Aim | Click/Space: Shoot
Edit code in the panel →
Every system is hackable!
`);
        };
    </script>

</body>
</html>
